FROM nvidia/cuda:9.0-base-ubuntu16.04 as base
LABEL maintainer="William Minshew <w@emrys.io>"

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    cuda-command-line-tools-9-0 \
    cuda-cublas-9-0 \
    cuda-cufft-9-0 \
    cuda-curand-9-0 \
    cuda-cusolver-9-0 \
    cuda-cusparse-9-0 \
    libcudnn7=7.0.5.15-1+cuda9.0 \
    python3-pip \
    python3-setuptools \
    && \
    apt-get clean && \
    apt-get autoremove && \
rm -rf /var/lib/apt/lists/*

RUN pip3 install --upgrade pip

ARG HOME="/home/user"
RUN useradd --create-home --home-dir $HOME user
WORKDIR $HOME
RUN pip3 --no-cache-dir --timeout=30 --retries=10 install -i http://devpi-svc:3141/root/pypi/+simple/ --trusted-host devpi-svc jupyter


FROM base
ARG HOME="/home/user"
COPY ./entrypoint.sh /entrypoint.sh
RUN ["chmod", "+x", "/entrypoint.sh"]
ARG REQS
COPY $REQS ./
RUN pip3 --no-cache-dir --timeout=30 --retries=10 install -i http://devpi-svc:3141/root/pypi/+simple/ --trusted-host devpi-svc -r $REQS

ARG NOTEBOOK
ARG HAS_MAIN
ARG MAIN
COPY $MAIN ./

ENV MAIN=$MAIN HAS_MAIN=$HAS_MAIN NOTEBOOK=$NOTEBOOK
RUN chown -R user:user $HOME
USER user
ENTRYPOINT ["/entrypoint.sh"]
