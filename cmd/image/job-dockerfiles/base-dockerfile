FROM nvidia/cuda:9.0-base-ubuntu16.04 as base
LABEL maintainer="William Minshew <w@emrys.io>"

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    cuda-command-line-tools-9-0 \
    cuda-cublas-9-0 \
    cuda-cufft-9-0 \
    cuda-curand-9-0 \
    cuda-cusolver-9-0 \
    cuda-cusparse-9-0 \
    libcudnn7=7.0.5.15-1+cuda9.0 \
    python3-pip \
    python3-setuptools \
    && \
    apt-get clean && \
    apt-get autoremove && \
rm -rf /var/lib/apt/lists/*

RUN pip3 install --upgrade pip

ARG HOME="/home/user"
RUN useradd --create-home --home-dir $HOME user \
&& chown -R user:user $HOME
WORKDIR $HOME
RUN pip3 --no-cache-dir --timeout=30 --retries=10 install -i http://devpi-svc:3141/root/pypi/+simple/ --trusted-host devpi-svc jupyter


FROM base
ARG DEVPI_HOST="http://devpi-svc:3141"
ARG DEVPI_TRUSTED_HOST="devpi-svc"
ARG PIP_TIMEOUT=30
ARG PIP_RETRIES=10
ARG REQS
COPY $REQS ./
RUN pip3 --no-cache-dir --timeout=$PIP_TIMEOUT --retries=$PIP_RETRIES install -i $DEVPI_HOST/root/pypi/+simple/ --trusted-host $DEVPI_TRUSTED_HOST -r $REQS

ARG NOTEBOOK=false
ENV NOTEBOOK $NOTEBOOK
ARG MAIN
ENV MAIN $MAIN
# re-copying REQS keeps command from failing if MAIN is blank, which may be the case for notebook jobs
COPY --chown=user:user $REQS $MAIN ./

USER user
CMD sh -c 'if [ "$NOTEBOOK" = true ]; then jupyter notebook --ip=0.0.0.0 --no-browser "$MAIN" ; else python3 "$MAIN" ; fi'
